<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greek Reader</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #333;
    }
    header, #controls, #sentences {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    #storySelect {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .sentence-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 1rem;
      background: #fafafa;
    }
    .text-column {
      flex: 1 1 45%;
    }
    .greek-button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background: transparent;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      line-height: 1.6;
      cursor: pointer;
      text-align: left;
    }
    .greek-button.playing {
      background: #ffeb3b;
      box-shadow: 0 0 5px 2px #fbc02d;
    }
    .english-text {
      padding: 0.5rem;
      font-size: 1.1rem;
      line-height: 1.6;
    }
    .control-button {
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .control-button:hover {
      background: #2980b9;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 600px) {
      .text-column {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ancient Greek Reader</h1>
  </header>
  <section id="controls">
    <select id="storySelect"></select>
    <div>
      <button id="toggleDisplayModeBtn" class="control-button">Display Mode: Both</button>
      <button id="playAllBtn" class="control-button">Play All</button>
      <button id="stopPlaybackBtn" class="control-button">Stop Playback</button>
    </div>
  </section>
  <section id="sentences"></section>
  <script>
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbykLd0c2O5gy7PFYstWMLQrbDaQT2pGaRuw5Yz9m8vBNrUTkXFBfRwSGM__UmqpAMe3/exec';

    let fullData = [];
    let currentSentences = [];
    let currentAudio = null;
    let isSequencePlaying = false;
    let displayMode = 'both';

    const storySelect = document.getElementById('storySelect');
    const sentencesDiv = document.getElementById('sentences');
    const toggleBtn = document.getElementById('toggleDisplayModeBtn');

    async function loadData() {
      try {
        const response = await fetch(DATA_URL);
        fullData = await response.json();
        populateStorySelect();
      } catch (e) {
        sentencesDiv.innerHTML = '<p style="color:red;">Error loading data. Please try again later.</p>';
      }
    }

    function populateStorySelect() {
      const stories = Array.from(new Set(fullData.map(row => row.storyId)));
      storySelect.innerHTML = '<option value="">-- Select a Story --</option>' +
        stories.map(id => `<option value="${id}">${id}</option>`).join('');
    }

    storySelect.addEventListener('change', () => {
      const selected = storySelect.value;
      currentSentences = fullData.filter(row => row.storyId === selected);
      renderSentences();
    });

    function renderSentences() {
      sentencesDiv.innerHTML = currentSentences.map((s, i) => `
        <div class="sentence-group">
          <div class="text-column greek-column">
            <button class="greek-button" data-index="${i}" data-audio="${s.audioLink}">${s.greek}</button>
          </div>
          <div class="text-column english-column">
            <div class="english-text">${s.english}</div>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.greek-button').forEach(btn => {
        let clickTimeout;
        btn.addEventListener('click', (e) => {
          if (clickTimeout) {
            clearTimeout(clickTimeout);
            clickTimeout = null;
            return;
          }
          clickTimeout = setTimeout(() => {
            const audio = e.target.dataset.audio;
            const idx = e.target.dataset.index;
            playAudio(audio, idx, true);
            clickTimeout = null;
          }, 250);
        });
        btn.addEventListener('dblclick', (e) => {
          clearTimeout(clickTimeout);
          clickTimeout = null;
          const audio = e.target.dataset.audio;
          const idx = e.target.dataset.index;
          playAudioMultiple(audio, idx, 5);
        });
      });
    }

    function playAudio(url, index, stopPrevious = false) {
      if (stopPrevious) stopAudio();
      const audio = new Audio(url);
      currentAudio = audio;
      highlight(index);
      audio.play().catch(console.error);
      audio.onended = () => {
        if (currentAudio === audio) {
          unhighlight(index);
          currentAudio = null;
        }
      };
    }

    async function playAudioMultiple(url, index, times) {
      stopAudio();
      isSequencePlaying = true;
      for (let i = 0; i < times && isSequencePlaying; i++) {
        await new Promise((resolve) => {
          const audio = new Audio(url);
          currentAudio = audio;
          highlight(index);
          audio.play().catch(console.error);
          audio.onended = resolve;
          audio.onpause = resolve;
        });
        if (i < times - 1 && isSequencePlaying) {
          await new Promise(r => setTimeout(r, 150));
        }
      }
      stopAudio();
    }

    function stopAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
      isSequencePlaying = false;
      document.querySelectorAll('.greek-button').forEach(b => b.classList.remove('playing'));
    }

    function highlight(index) {
      document.querySelectorAll('.greek-button').forEach(b => b.classList.remove('playing'));
      const btn = document.querySelector(`.greek-button[data-index="${index}"]`);
      if (btn) btn.classList.add('playing');
    }

    function unhighlight(index) {
      const btn = document.querySelector(`.greek-button[data-index="${index}"]`);
      if (btn) btn.classList.remove('playing');
    }

    document.getElementById('stopPlaybackBtn').addEventListener('click', stopAudio);

    document.getElementById('playAllBtn').addEventListener('click', async () => {
      if (!currentSentences.length) return;
      stopAudio();
      isSequencePlaying = true;
      for (let i = 0; i < currentSentences.length && isSequencePlaying; i++) {
        await new Promise((resolve) => {
          const audio = new Audio(currentSentences[i].audioLink);
          currentAudio = audio;
          highlight(i);
          audio.play().catch(console.error);
          audio.onended = resolve;
          audio.onpause = resolve;
        });
        if (i < currentSentences.length - 1 && isSequencePlaying) {
          await new Promise(r => setTimeout(r, 200));
        }
      }
      stopAudio();
    });

    toggleBtn.addEventListener('click', () => {
      displayMode = displayMode === 'both' ? 'greekOnly' : displayMode === 'greekOnly' ? 'englishOnly' : 'both';
      toggleBtn.textContent = `Display Mode: ${displayMode === 'both' ? 'Both' : displayMode === 'greekOnly' ? 'Greek Only' : 'English Only'}`;
      document.querySelectorAll('.english-column').forEach(el => el.classList.toggle('hidden', displayMode === 'greekOnly'));
      document.querySelectorAll('.greek-column').forEach(el => el.classList.toggle('hidden', displayMode === 'englishOnly'));
    });

    loadData();
  </script>
</body>
</html>